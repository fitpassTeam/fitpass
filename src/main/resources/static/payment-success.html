<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <link
      rel="icon"
      href="https://static.toss.im/icons/png/4x/icon-toss-logo.png"
    />
    <link rel="stylesheet" type="text/css" href="./style.css" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FitPass ê²°ì œ ì™„ë£Œ</title>
  </head>
  <body>
    <div class="result wrapper">
      <div class="box_section">
        <h2 style="padding: 20px 0px 10px 0px; color: #4F46E5;">
          <img
            width="35px"
            src="https://static.toss.im/3d-emojis/u1F389_apng.png"
          />
          ğŸ‹ï¸ FitPass í¬ì¸íŠ¸ ì¶©ì „ ì™„ë£Œ!
        </h2>

        <p id="paymentKey"></p>
        <p id="orderId"></p>
        <p id="amount"></p>
        
        <div style="margin-top: 30px;">
          <button class="button" onclick="goToMainPage()" style="margin-right: 10px;">
            ë©”ì¸ìœ¼ë¡œ
          </button>
          <button class="button" onclick="goToPaymentPage()">
            ì¶”ê°€ ì¶©ì „
          </button>
        </div>
      </div>
    </div>
    
    <script>
      // ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ê°’ì´ ê²°ì œ ìš”ì²­í•  ë•Œ ë³´ë‚¸ ë°ì´í„°ì™€ ë™ì¼í•œì§€ ë°˜ë“œì‹œ í™•ì¸í•˜ì„¸ìš”.
      // í´ë¼ì´ì–¸íŠ¸ì—ì„œ ê²°ì œ ê¸ˆì•¡ì„ ì¡°ì‘í•˜ëŠ” í–‰ìœ„ë¥¼ ë°©ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      const urlParams = new URLSearchParams(window.location.search);

      // ì„œë²„ë¡œ ê²°ì œ ìŠ¹ì¸ì— í•„ìš”í•œ ê²°ì œ ì •ë³´ë¥¼ ë³´ë‚´ì„¸ìš”.
      async function confirm() {
        const requestData = {
          paymentKey: urlParams.get("paymentKey"),
          orderId: urlParams.get("orderId"),
          amount: parseInt(urlParams.get("amount")),
        };

        try {
          const response = await fetch("/api/payments/confirm", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(requestData),
          });

          const json = await response.json();

          if (!response.ok) {
            // ê²°ì œ ì‹¤íŒ¨ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
            console.log(json);
            window.location.href = `/payment/fail?message=${json.message}&code=${json.code}`;
            return;
          }

          // ê²°ì œ ì„±ê³µ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
          console.log("âœ… ê²°ì œ ìŠ¹ì¸ ì„±ê³µ:", json);
          
          // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
          document.querySelector('h2').innerHTML = `
            <img width="35px" src="https://static.toss.im/3d-emojis/u1F389_apng.png" />
            ğŸ‰ í¬ì¸íŠ¸ ì¶©ì „ ì™„ë£Œ!
          `;
          
        } catch (error) {
          console.error("ê²°ì œ ìŠ¹ì¸ ìš”ì²­ ì‹¤íŒ¨:", error);
          window.location.href = `/payment/fail?message=ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤`;
        }
      }
      
      // ì¦‰ì‹œ ê²°ì œ ìŠ¹ì¸ ìš”ì²­
      confirm();

      const paymentKeyElement = document.getElementById("paymentKey");
      const orderIdElement = document.getElementById("orderId");
      const amountElement = document.getElementById("amount");

      orderIdElement.textContent = "ì£¼ë¬¸ë²ˆí˜¸: " + urlParams.get("orderId");
      amountElement.textContent = "ì¶©ì „ ê¸ˆì•¡: " + parseInt(urlParams.get("amount")).toLocaleString() + "ì›";
      paymentKeyElement.textContent = "ê²°ì œí‚¤: " + urlParams.get("paymentKey");
      
      function goToMainPage() {
        window.location.href = "/";
      }
      
      function goToPaymentPage() {
        window.location.href = "/payment.html";
      }
    </script>
  </body>
</html>