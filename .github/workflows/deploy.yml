  name: Deploy

  on:
    workflow_dispatch:
    push:
      branches:
        - main
        - dev
        - fix/Authorization

  jobs:
    deploy:
      runs-on: ubuntu-latest
      steps:
        - name: Checkout
          uses: actions/checkout@v4

        - name: Set up JDK 17
          uses: actions/setup-java@v4
          with:
            java-version: '17'
            distribution: 'adopt'

        - name: Grant execute permission for gradlew
          run: chmod +x ./gradlew

        - name: gradlew bootJar
          run: ./gradlew bootJar

        - name: Debug paths in GitHub Actions
          run: |
            echo "Checking paths to be copied"
            ls -la ./build/libs
            ls -la ./

        - name: Create .env file
          run: |
            echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> .env
            echo "DB_NAME=${{ secrets.DB_NAME }}" >> .env
            echo "DB_USERNAME=${{ secrets.DB_USERNAME }}" >> .env
            echo "SQL_PORT=${{ secrets.SQL_PORT }}" >> .env
            echo "SECRET_KEY=${{ secrets.SECRET_KEY }}" >> .env
            echo "ACCESS_KEY=${{ secrets.ACCESS_KEY }}" >> .env
            echo "AWS_SECRET_KEY=${{ secrets.AWS_SECRET_KEY }}" >> .env
            echo "OAUTH_NAVER_CLIENT_ID=${{ secrets.OAUTH_NAVER_CLIENT_ID }}" >> .env
            echo "OAUTH_NAVER_CLIENT_SECRET=${{ secrets.OAUTH_NAVER_CLIENT_SECRET }}" >> .env
            echo "REDIS_HOST=redis" >> .env
            echo "REDIS_PORT=6379" >> .env
            echo "RDS_ENDPOINT=${{ secrets.RDS_ENDPOINT }}" >> .env
          shell: bash

        - name: Debug check exact .env location
          run: |
            find . -name ".env"

        - name: Copy all docker-related files to server
          uses: appleboy/scp-action@master
          with:
            host: ${{ secrets.SSH_HOST }}
            username: ubuntu
            key: ${{ secrets.SSH_KEY }}
            port: 22
            source: './build/libs/*.jar,./Dockerfile,./docker-compose-prod.yml,.env,src/main/resources/application.properties,src/main/resources/application-prod.properties'
            target: "~/fitpass"

        - name: Deploy Spring App
          uses: appleboy/ssh-action@v0.1.6
          with:
            host: ${{ secrets.HOST }}
            username: ${{ secrets.USERNAME }}
            key: ${{ secrets.PRIVATE_KEY }}
            port: 22
            script: |
              echo "ğŸ§¹ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ"
              docker-compose -f docker-compose-prod.yml down || true
              docker rm -f redis || true
              docker rm -f spring-app || true
              
              echo "ğŸš€ ìƒˆ ì»¨í…Œì´ë„ˆ ë¹Œë“œ ë° ì‹œì‘"
              docker-compose -f docker-compose-prod.yml up --build -d
              
              echo "ğŸ“œ ìµœê·¼ ë¡œê·¸ ì¶œë ¥"
              docker-compose -f docker-compose-prod.yml logs --tail=50
              
              echo "â± spring ì»¨í…Œì´ë„ˆ ì‹œì‘ ëŒ€ê¸° (10ì´ˆ)"
              sleep 10
              
              echo "ğŸ” spring ë¡œê·¸ í™•ì¸ (ì´ˆê¸° ìƒíƒœ)"
              docker-compose -f docker-compose-prod.yml logs spring-app --tail=50
              
              echo "ğŸ’¡ ì„œë¹„ìŠ¤ í—¬ìŠ¤ì²´í¬ ì‹œì‘..."
              for i in {1..15}; do
                echo "â³ ($i/15) curl ì‹œë„ ì¤‘..."
                RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" http://localhost:8080/actuator/health || echo "FAILED")
                echo "ğŸ’¬ Raw RESPONSE:"
                echo "$RESPONSE"
                if [[ "$RESPONSE" == *"FAILED"* ]]; then
                  echo "ğŸš« curl ì‹¤í–‰ ìì²´ ì‹¤íŒ¨"
                  STATUS="000"
                  BODY=""
                else
                  STATUS=$(echo "$RESPONSE" | grep "HTTP_CODE" | cut -d':' -f2)
                  BODY=$(echo "$RESPONSE" | sed '/^HTTP_CODE:/d')
                fi
              done