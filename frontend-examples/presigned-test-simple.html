<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Presigned URL ê°„ë‹¨ í…ŒìŠ¤íŠ¸</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button { padding: 10px 20px; margin: 5px; }
    </style>
</head>
<body>
    <h1>ğŸ§ª Presigned URL ë‹¨ê³„ë³„ í…ŒìŠ¤íŠ¸</h1>
    
    <div>
        <h3>1ë‹¨ê³„: Presigned URL ë°›ê¸°</h3>
        <input type="file" id="fileInput" accept="image/*">
        <button onclick="getPresignedUrl()">Presigned URL ë°›ê¸°</button>
        <div id="urlResult" class="result info">íŒŒì¼ì„ ì„ íƒí•˜ê³  ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</div>
    </div>

    <div>
        <h3>2ë‹¨ê³„: ë°›ì€ URLë¡œ ì—…ë¡œë“œ (ìˆ˜ë™)</h3>
        <div id="uploadInstructions" class="result info">
            1ë‹¨ê³„ë¥¼ ë¨¼ì € ì™„ë£Œí•˜ì„¸ìš”
        </div>
        <button onclick="testS3Upload()" id="uploadBtn" disabled>S3 ì—…ë¡œë“œ í…ŒìŠ¤íŠ¸</button>
        <div id="uploadResult" class="result info">ì—…ë¡œë“œ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div>
    </div>

    <script>
        let currentPresignedUrl = null;
        let currentFile = null;
        let currentFileName = null;

        async function getPresignedUrl() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            const resultDiv = document.getElementById('urlResult');
            
            if (!file) {
                alert('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”!');
                return;
            }

            currentFile = file;
            resultDiv.textContent = 'Presigned URL ìš”ì²­ ì¤‘...';
            resultDiv.className = 'result info';

            try {
                const params = new URLSearchParams({
                    filename: file.name,
                    contentType: file.type
                });

                const response = await fetch(`http://localhost:8080/images/presigned-url?${params}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                currentPresignedUrl = data.data.presignedUrl;
                currentFileName = data.data.fileName;

                resultDiv.innerHTML = `
                    <strong>âœ… Presigned URL ë°›ê¸° ì„±ê³µ!</strong><br><br>
                    <strong>íŒŒì¼ëª…:</strong> ${currentFileName}<br>
                    <strong>Content-Type:</strong> ${data.data.contentType}<br>
                    <strong>ë§Œë£Œì‹œê°„:</strong> ${data.data.expiresIn}ì´ˆ<br><br>
                    <strong>Presigned URL:</strong><br>
                    <textarea readonly style="width: 100%; height: 60px; font-size: 10px;">${currentPresignedUrl}</textarea>
                `;
                resultDiv.className = 'result success';

                // ì—…ë¡œë“œ ë²„íŠ¼ í™œì„±í™”
                document.getElementById('uploadBtn').disabled = false;
                document.getElementById('uploadInstructions').innerHTML = `
                    <strong>ğŸ“‹ ìˆ˜ë™ í…ŒìŠ¤íŠ¸ ë°©ë²•:</strong><br>
                    1. ìœ„ì˜ Presigned URLì„ ë³µì‚¬í•˜ì„¸ìš”<br>
                    2. ìƒˆ ë¸Œë¼ìš°ì € íƒ­ì—ì„œ ê°œë°œì ë„êµ¬ ì—´ê¸° (F12)<br>
                    3. Console íƒ­ì—ì„œ ë‹¤ìŒ ì½”ë“œ ì‹¤í–‰:<br><br>
                    <code style="background: #f8f9fa; padding: 10px; display: block; font-size: 12px;">
// íŒŒì¼ ì„ íƒ<br>
const input = document.createElement('input');<br>
input.type = 'file';<br>
input.accept = 'image/*';<br>
input.click();<br><br>
input.onchange = async (e) => {<br>
&nbsp;&nbsp;const file = e.target.files[0];<br>
&nbsp;&nbsp;const response = await fetch('${currentPresignedUrl}', {<br>
&nbsp;&nbsp;&nbsp;&nbsp;method: 'PUT',<br>
&nbsp;&nbsp;&nbsp;&nbsp;headers: { 'Content-Type': '${file.type}' },<br>
&nbsp;&nbsp;&nbsp;&nbsp;body: file<br>
&nbsp;&nbsp;});<br>
&nbsp;&nbsp;console.log('ì—…ë¡œë“œ ê²°ê³¼:', response.status, response.statusText);<br>
};
                    </code>
                `;
                document.getElementById('uploadInstructions').className = 'result info';

            } catch (error) {
                resultDiv.textContent = `âŒ Presigned URL ìš”ì²­ ì‹¤íŒ¨: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }

        async function testS3Upload() {
            if (!currentPresignedUrl || !currentFile) {
                alert('ë¨¼ì € Presigned URLì„ ë°›ì•„ì•¼ í•©ë‹ˆë‹¤!');
                return;
            }

            const resultDiv = document.getElementById('uploadResult');
            resultDiv.textContent = 'S3 ì—…ë¡œë“œ ì¤‘...';
            resultDiv.className = 'result info';

            try {
                const response = await fetch(currentPresignedUrl, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': currentFile.type
                    },
                    body: currentFile
                });

                console.log('S3 Response:', response);
                console.log('Response Headers:', [...response.headers.entries()]);

                if (response.ok) {
                    const finalUrl = `https://fit-pass-1.s3.ap-northeast-2.amazonaws.com/${currentFileName}`;
                    resultDiv.innerHTML = `
                        <strong>ğŸ‰ S3 ì—…ë¡œë“œ ì„±ê³µ!</strong><br><br>
                        <strong>HTTP ìƒíƒœ:</strong> ${response.status} ${response.statusText}<br>
                        <strong>ìµœì¢… ì´ë¯¸ì§€ URL:</strong><br>
                        <a href="${finalUrl}" target="_blank">${finalUrl}</a><br><br>
                        <strong>ğŸ† Presigned URL ë°©ì‹ ì™„ì „ ì„±ê³µ!</strong>
                    `;
                    resultDiv.className = 'result success';
                } else {
                    throw new Error(`S3 ì—…ë¡œë“œ ì‹¤íŒ¨: ${response.status} ${response.statusText}`);
                }

            } catch (error) {
                resultDiv.innerHTML = `
                    <strong>âŒ S3 ì—…ë¡œë“œ ì‹¤íŒ¨!</strong><br><br>
                    <strong>ì˜¤ë¥˜:</strong> ${error.message}<br><br>
                    <strong>ğŸ”§ í•´ê²° ë°©ë²•:</strong><br>
                    1. S3 ë²„í‚·ì˜ CORS ì„¤ì • í™•ì¸<br>
                    2. AWS ì½˜ì†”ì—ì„œ fit-pass-1 ë²„í‚· â†’ Permissions â†’ CORS ì„¤ì •<br>
                    3. í•„ìš”í•œ CORS ì •ì±…ì„ ì¶”ê°€í•˜ì„¸ìš”<br><br>
                    <strong>ğŸ“‹ í•„ìš”í•œ CORS ì„¤ì •:</strong><br>
                    <code style="background: #f8f9fa; padding: 10px; display: block; font-size: 12px;">
[{<br>
&nbsp;&nbsp;"AllowedHeaders": ["*"],<br>
&nbsp;&nbsp;"AllowedMethods": ["GET", "PUT", "POST", "DELETE", "HEAD"],<br>
&nbsp;&nbsp;"AllowedOrigins": ["*"],<br>
&nbsp;&nbsp;"ExposeHeaders": ["ETag"]<br>
}]
                    </code>
                `;
                resultDiv.className = 'result error';
            }
        }
    </script>
</body>
</html>
